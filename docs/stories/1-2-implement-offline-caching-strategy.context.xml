<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.2</storyId>
    <title>Implement Offline Caching Strategy</title>
    <status>drafted</status>
    <generatedAt>2025-11-06</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-2-implement-offline-caching-strategy.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>visitor at Web Summit</asA>
    <iWant>the microsite to work offline after initial load</iWant>
    <soThat>I can use it even when conference Wi-Fi is unreliable</soThat>
    <tasks>
      <task id="1" ac="1">Implement cache-first strategy for static assets</task>
      <task id="2" ac="1">Implement network-first strategy for API calls</task>
      <task id="3" ac="1">Pre-cache critical assets on service worker install</task>
      <task id="4" ac="2">Cache routes (landing, catalog, product detail, cart, checkout)</task>
      <task id="5" ac="3">Create offline fallback page</task>
      <task id="6" ac="4">Implement cache versioning system</task>
      <task id="7" ac="5">Implement cache size limits</task>
      <task id="8" ac="1,3">Fix fetch handler error handling (from Story 1.1 review)</task>
      <task id="9" ac="1,2,3,4,5,6">Testing and validation</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Service worker caches critical HTML, CSS, JS, and image assets on first visit</ac>
    <ac id="2">Cached routes include: landing page, catalog, product detail, cart, checkout</ac>
    <ac id="3">Offline fallback page displays when network unavailable and route not cached</ac>
    <ac id="4">Cache versioning implemented to force updates when content changes</ac>
    <ac id="5">Cache size limits prevent excessive storage usage</ac>
    <ac id="6">Works on throttled 3G connection (per PRD performance requirements)</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/tech-spec-epic-1.md" title="Epic Technical Specification: Foundation & Infrastructure" section="Services and Modules">
        Service Worker module responsibilities, cache management patterns, and API interfaces for offline caching strategy implementation.
      </doc>
      <doc path="docs/tech-spec-epic-1.md" title="Epic Technical Specification: Foundation & Infrastructure" section="APIs and Interfaces">
        Service Worker API patterns including cache-first, network-first, and network-first with fallback strategies. Cache versioning and cleanup patterns.
      </doc>
      <doc path="docs/tech-spec-epic-1.md" title="Epic Technical Specification: Foundation & Infrastructure" section="Workflows and Sequencing">
        Offline Caching Flow detailing cache-first for static assets, network-first for API calls, and fallback patterns for routes.
      </doc>
      <doc path="docs/tech-spec-epic-1.md" title="Epic Technical Specification: Foundation & Infrastructure" section="Acceptance Criteria">
        Story 1.2 acceptance criteria (ACs 7-12) defining requirements for offline caching implementation.
      </doc>
      <doc path="docs/epics.md" title="makelocal-websimmit-demo - Epic Breakdown" section="Story 1.2">
        User story, acceptance criteria, prerequisites, and technical notes for implementing offline caching strategy using Cache API.
      </doc>
      <doc path="docs/prd.md" title="Product Requirements Document - MakeLocal Web Summit Microsite" section="7.9">
        PRD requirements for offline caching (FR-32, FR-33) and event resilience. Performance requirements for throttled 3G connection.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Overview">
        Next.js 16 App Router architecture, single-page marketing site pattern. Service worker integration points and static asset serving.
      </doc>
      <doc path="docs/stories/1-1-create-pwa-manifest-and-service-worker-foundation.md" title="Story 1.1: Create PWA Manifest and Service Worker Foundation">
        Previous story learnings: service worker foundation, cache versioning pattern, install/activate handlers, and pending fetch handler error handling fix.
      </doc>
    </docs>
    <code>
      <file path="public/sw.js" kind="service-worker" symbol="Service Worker" lines="1-58" reason="Current service worker implementation with basic lifecycle. Extend fetch handler for cache-first, network-first strategies, and offline fallback.">
        <snippet>const CACHE_VERSION = 'v1.0.0';
const CACHE_NAME = `makelocal-cache-${CACHE_VERSION}`;</snippet>
      </file>
      <file path="src/lib/register-sw.ts" kind="utility" symbol="registerServiceWorker" lines="6-40" reason="Service worker registration utility. Reuse as-is, no changes needed for Story 1.2.">
        <snippet>export function registerServiceWorker(): void {
  if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')</snippet>
      </file>
      <file path="src/components/ServiceWorkerRegistration.tsx" kind="component" symbol="ServiceWorkerRegistration" lines="9-15" reason="React client component for service worker registration. Reuse as-is, no changes needed.">
        <snippet>export function ServiceWorkerRegistration() {
  useEffect(() => {
    registerServiceWorker();
  }, []);
  return null;
}</snippet>
      </file>
      <file path="src/app/layout.tsx" kind="layout" symbol="RootLayout" lines="17-37" reason="Root layout with service worker registration integration. Manifest link present. No changes needed for Story 1.2.">
        <snippet>&lt;link rel="manifest" href="/manifest.json" /&gt;
&lt;ServiceWorkerRegistration /&gt;</snippet>
      </file>
      <file path="public/manifest.json" kind="manifest" symbol="PWA Manifest" lines="1-24" reason="PWA manifest with required fields. Already configured for Story 1.1. No changes needed for Story 1.2.">
        <snippet>{
  "name": "MakeLocal - Web Summit Demo",
  "start_url": "/",
  "display": "standalone"
}</snippet>
      </file>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="next" version="16.0.1">Next.js framework with App Router and static export support</package>
        <package name="react" version="19.2.0">React UI library compatible with service worker APIs</package>
        <package name="react-dom" version="19.2.0">React DOM rendering</package>
        <package name="typescript" version="^5">TypeScript for type safety in registration utilities</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Service worker at `public/sw.js` controls all routes. Cache strategies must handle all request types (static assets, routes, API calls).</constraint>
    <constraint>Use native Cache API (`caches.open()`, `cache.add()`, `cache.addAll()`, `cache.match()`) for all caching operations.</constraint>
    <constraint>Cache-First strategy for static assets (CSS, JS, images, fonts) - fastest performance, works offline.</constraint>
    <constraint>Network-First strategy for API calls and routes - ensures fresh data when online, falls back to cache when offline.</constraint>
    <constraint>Network-First with Fallback for routes - attempts network, falls back to cache, then offline page.</constraint>
    <constraint>Next.js 16 App Router: Routes are server-rendered by default. Cache route HTML responses from network fetches.</constraint>
    <constraint>Static assets served from `public/` or Next.js build output.</constraint>
    <constraint>Service worker code uses standard Web APIs, no React-specific code required.</constraint>
    <constraint>Service worker file (`sw.js`) can remain JavaScript, but ensure type safety in registration utilities.</constraint>
    <constraint>Cache versioning: Increment `CACHE_VERSION` constant on deployments to invalidate old caches.</constraint>
    <constraint>Cache size limits: Monitor total cache size, implement cleanup when limit exceeded (e.g., 50MB).</constraint>
    <constraint>Fix fetch handler error handling: Return proper Response object on network failure, not undefined.</constraint>
  </constraints>

  <interfaces>
    <interface name="Cache API" kind="browser-api" signature="caches.open(cacheName: string): Promise&lt;Cache&gt;" path="public/sw.js">
      Native browser API for cache storage. Used for opening cache stores, adding/retrieving cached responses.
    </interface>
    <interface name="Service Worker Install Event" kind="event-handler" signature="self.addEventListener('install', (event: ExtendableEvent) =&gt; {...})" path="public/sw.js">
      Install event handler for pre-caching critical assets on service worker installation.
    </interface>
    <interface name="Service Worker Activate Event" kind="event-handler" signature="self.addEventListener('activate', (event: ExtendableEvent) =&gt; {...})" path="public/sw.js">
      Activate event handler for cache cleanup and old cache deletion. Already implemented, verify for Story 1.2.
    </interface>
    <interface name="Service Worker Fetch Event" kind="event-handler" signature="self.addEventListener('fetch', (event: FetchEvent) =&gt; {...})" path="public/sw.js">
      Fetch event handler for intercepting network requests. Currently minimal, needs full implementation for cache-first, network-first strategies.
    </interface>
    <interface name="Service Worker Registration API" kind="browser-api" signature="navigator.serviceWorker.register(scriptURL: string): Promise&lt;ServiceWorkerRegistration&gt;" path="src/lib/register-sw.ts">
      Service worker registration API. Already implemented in registration utility, reuse as-is.
    </interface>
  </interfaces>

  <tests>
    <standards>
      Manual testing via browser DevTools is sufficient for Story 1.2. Test offline mode, cache behavior, and network throttling using Chrome DevTools Application and Network tabs. Verify cache contents, cache-first behavior for static assets, network-first behavior for API calls, and offline fallback page display.
    </standards>
    <locations>
      Manual testing via browser DevTools. No automated test files required per story requirements.
    </locations>
    <ideas>
      <test ac="1">Test offline mode: Load site, go offline, verify cached routes work. Verify static assets served from cache.</test>
      <test ac="1">Test cache-first: Verify static assets (CSS, JS, images) served from cache in Chrome DevTools Network tab.</test>
      <test ac="1">Test network-first: Verify API calls attempt network first, fall back to cache when offline.</test>
      <test ac="2">Test route caching: Navigate to routes (/catalog, /product/[id], /cart, /checkout) offline, verify cached routes served.</test>
      <test ac="3">Test offline fallback: Navigate to uncached route offline, verify offline fallback page displays.</test>
      <test ac="4">Test cache versioning: Deploy with new version, verify old caches deleted on activate event.</test>
      <test ac="5">Test cache size limits: Load large assets, verify cleanup when limit exceeded (FIFO deletion).</test>
      <test ac="6">Test throttled 3G: Use Chrome DevTools throttling (3G), verify functionality maintained.</test>
      <test ac="1,3">Test error handling: Verify fetch handler returns proper Response object on network failure, not undefined.</test>
    </ideas>
  </tests>
</story-context>

